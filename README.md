# RSCHS API Server - Сервер оповещений о тревоге

## ⚠️ Важное предупреждение

**Этот сервер НЕ является официальным источником оповещения об опасности!** Он работает через неофициальный телеграм канал оповещения об опасности. **Используйте этот сервис на свой страх и риск.**

## Описание проекта

API сервер для удобного оповещения различных DIY устройств о воздушной тревоге. Поскольку отсутствует официальный ресурс для получения информации об опасности, данный проект предоставляет неофициальный способ получения информации о тревоге через мониторинг телеграм каналов.

## Как это работает

1. Сервер периодически проверяет указанный телеграм канал
2. Анализирует сообщения на наличие ключевых слов начала/окончания тревоги
3. Сохраняет новые сообщения в базу данных
4. Уведомляет подключенных клиентов через WebSocket о изменении статуса

## Технологии

- **Node.js** + **TypeScript**
- **Fastify** для REST API
- **WebSocket** для real-time уведомлений
- **SQLite** + **TypeORM** для хранения данных
- **Cheerio** для парсинга HTML
- **ESLint** для контроля качества кода
- **Docker** для контейнеризации

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd rschs-server-alert
```

### 2. Настройка окружения

Скопируйте `.env.example` в `.env` и настройте параметры:

```bash
cp .env.example .env
```

### 3. Конфигурация .env файла

```env
PORT=3000
NODE_ENV=development
TELEGRAM_CHANNEL_URL=https://t.me/s/your_channel/message_id
LIST_START_KEYWORDS="Опасность по БПЛА,Повторно,Внимание по БПЛА"
LIST_STOP_KEYWORDS="Отбой опасности по БПЛА,Отбой"
CHECK_TIMEOUT=120000

DB_TYPE=sqlite
DB_DATABASE=database.sqlite
DB_SYNCHRONIZE=true
DB_LOGGING=false
```

### 4. Запуск

#### С помощью Docker (рекомендуется)

```bash
docker compose up -d
```

#### Локальный запуск

```bash
# Установка зависимостей
npm install

# Разработка
npm run dev

# Продакшн
npm run build
npm start
```

## Настройка ключевых слов

**Важно:** Не копируйте весь текст сообщений целиком, так как он может изменяться. Используйте конкретные ключевые слова или наборы слов.

### Примеры ключевых слов:

**Начало тревоги:**
- "Опасность по БПЛА"
- "Внимание по БПЛА" 
- "Повторно"

**Окончание тревоги:**
- "Отбой опасности по БПЛА"
- "Отбой"

## API

### REST API

#### Получить последнее сообщение о тревоге
```
GET /alerts/latest
```

#### Получить все сообщения с пагинацией
```
GET /alerts?page=1&limit=10
```

#### Получить статус тревоги
```
GET /alerts/status
```

### WebSocket подключение

```javascript
const ws = new WebSocket('ws://localhost:3000/ws');

ws.on('message', (data) => {
  const alert = JSON.parse(data);
  console.log('Статус тревоги:', alert);
});
```

### Формат сообщений

```json
{
  "message": "Текст сообщения о тревоге",
  "date": "2024-01-01T12:00:00.000Z",
  "type": "start" // или "stop"
}
```

## Структура проекта

```
src/
├── config/          # Конфигурация приложения
├── database/        # Настройки БД и сущности
│   └── entities/    # TypeORM сущности
├── routes/          # REST API маршруты
├── index.ts         # Главный файл сервера
└── rschs.ts         # Логика мониторинга каналов
```

## Скрипты

```bash
npm run dev        # Запуск в режиме разработки
npm run build      # Сборка проекта
npm start          # Запуск продакшн версии
npm run lint       # Проверка кода
npm run lint:fix   # Исправление ошибок линтера
```

## Принцип работы

1. **Мониторинг:** Каждые {CHECK_TIMEOUT} миллисекунд проверяется телеграм канал
2. **Парсинг:** Извлекаются сообщения и анализируются ключевые слова
3. **Фильтрация:** Сохраняются только новые сообщения с релевантными ключевыми словами
4. **Уведомления:** Клиенты получают уведомления через WebSocket при изменении статуса

## Безопасность

- Сервер не хранит персональные данные
- Используется только публичная информация из телеграм каналов
- Рекомендуется использовать HTTPS в продакшн среде

## Лицензия

Проект предоставляется "как есть" без каких-либо гарантий. Используйте на свой страх и риск.